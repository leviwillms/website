# New Alignment Algorithm

## Refining the Alignment

I've implemented a new alignment algorithm that changed the scoring decision-making. It seems to have proven some solid results (returned from OpenAI API using `gpt-5.2`):

```bash
======================================================================
ACCURACY COMPARISON: OLD vs NEW ALGORITHM
======================================================================
OLD: 944 alignments, 33 incorrect (3.5%)
NEW: 939 alignments, 25 incorrect (2.7%)

Error reduction: 33 → 25 = 8 fewer errors
Relative improvement: 24.2% fewer false positives

======================================================================
FIXED (Mistral IDs no longer incorrect): 21
======================================================================
  437: PPX begins with “convolution The basic implementation structure is il-” which re...
  458: PPX only contains '(2)' but Mistral fragment 458 shows equation (1) unrelated to...
  476: PPX 'space2.' does not correspond to the numbered statement about ReLU preservin...
  480: PPX only contains 'as', which is too generic and not a reliable partial match to...
  505: PPX text “put channels.” does not match or appear within the Mistral fragment ab...
  511: PPX mentions a 'memory efficient implementation', while the Mistral text is abou...
  513: Mistral fragment is empty, so no verifiable match to the PPX text 'sults'....
  527: PPX text is too fragmentary (“Rs(c× s,”) and does not clearly correspond to any ...
  541: PPX '2015.1' does not match the content of the '6.1 ImageNet Classification' hea...
  545: PPX “000020” does not correspond to any text content in the training-hyperparame...
  548: PPX is the heading '5. Implementation Notes' but Mistral fragment is a 'Results'...
  577: PPX only says 'dataset.' which is too generic and does not clearly correspond to...
  603: PPX “desired. d,” does not match any distinctive substring of the Dynamic networ...
  606: PPX “time improvements.” does not appear in or uniquely correspond to the Veniat...
  615: PPX mentions "IEEE Conference on Computer Vision and Pattern" which aligns with ...
  624: PPX only shows 'ful.' which is too generic and does not specifically map to the ...
  645: PPX text is only a '|' character with no identifiable content to align to the sp...
  660: PPX 'm−n (' is a generic fragment; Mistral is a corollary statement about m>>n a...
  669: PPX 'mn+1' does not correspond to the symmetry condition statement about p(DB)=p...
  673: PPX 'm−n' alone is too generic and does not clearly correspond to the specific e...
  696: PPX 'B∈opout' refers to a symbol in a memory formula, not the section heading 'S...

======================================================================
NEW ERRORS (not in old results): 8
======================================================================
  421: PPX only has 'ments.' (likely end of 'Acknowledgments'), while Mistral is an ema...
  466: PPX 'space2.' does not align with or appear in the Mistral paragraph about width...
  537: PPX 'time improvements.' is too generic and does not appear as a recognizable su...
  552: PPX fragment is a mathematical constraint (op∈G), but Mistral text is about obje...
  608: PPX ends with "abs/1702.0257" but Mistral reference is "abs/1702.06257"; the cit...
  612: PPX '2017.2' is an isolated date-like fragment, while Mistral is the full ICML 2...
  683: PPX only contains "V −" which is too minimal/ambiguous; it does not clearly corr...
  694: PPX is just 'm−n (' which is too generic and does not clearly correspond to the ...

======================================================================
STILL INCORRECT (in both): 5
======================================================================
  565
  600
  632
  679
  689
```

The primary change was..

### Further Analysis

Now, let's take a look at some of these new failings. In particular, text_fragment_id=421.

Old:

```
2132,ments.,421,"{sandler, howarda, menglong, azhmogin, lcchen}@google.com",4.0,0.8,dp
```

New:

```
421: PPX only has 'ments.' (likely end of 'Acknowledgments'), while Mistral is an ema...
2132,ments.,421,"{sandler, howarda, menglong, azhmogin, lcchen}@google.com",6.067800223779924,0.5871688730808885,dp
```

Notice how they are the same but the detection by OpenAI that it is correct differs. That is problematic. How can I ensure that OpenAI remains constant in its analysis?

Also, here are the analyses from OpenAI

New:

```json
  {
    "ppx_fragment_id": 2132,
    "mistral_fragment_id": 421,
    "correct": false,
    "reasoning": "PPX only has 'ments.' (likely end of 'Acknowledgments'), while Mistral is an email address line; not a direct textual match."
  },
```

Old:

```json
  {
    "ppx_fragment_id": 2132,
    "mistral_fragment_id": 421,
    "correct": true,
    "reasoning": "PPX 'ments.,' is a truncated tail of the author email block; Mistral fragment 421 contains the full email list."
  },
```

This is what the real text SHOULD map to:

```
Figure 3 provides a schematic visualization of the differ-
ence in the designs. The motivation for inserting short-
cuts is similar to that of classical residual connections:
we want to improve the ability of a gradient to propagate
across multiplier layers. However, the inverted design is
considerably more memory efficient (see Section 5 for
details), as well as works slightly better in our experi-
ments
```

```bash
485 | Figure 3 provides a schematic visualization of the difference in the designs. The motivation for inserting shortcuts is similar to that of classical residual connections:
we want to improve the ability of a gradient to propagate across multiplier layers. However, the inverted design is considerably more memory efficient (see Section 5 for details)
, as well as works slightly better in our experiments.
```

Which is `mistral_fragment_id = 485`.

## TODO

1. Create a method to track versions of the algorithm to run experiments on.
2. Sort out code changes. Commit code to the remote repository
3. Create spatial location function that will retrieve a given fragments neighbors
4. Create Claude skills for the codebase
5. Refactor some functionality
6. Create ground-truth dataset

## Thoughts

- What if we take the PPX text_fragment with the overlap of the page_element as the context window for the alignment?
- Then, the context window greatly increases because we have a larger sample for the ppx text_fragment..
- If we use this as as fallback, when to we trigger the fallback? When `score < 10`, `confidence <1.0`
- We are creating a context window for a text fragment within a page element. Then we generate that context window score from the start and end of the combined tokens for all the fragments in the page element.
