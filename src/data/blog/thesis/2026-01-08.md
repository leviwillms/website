# Most productive day yet

Published: true

## State of Research

Yesterday some monumental progress was made. I was able to finish the rough design of the query system and implement the embedding algorithm. The initial results are fantastic! It's beautiful to see our ideas come to life. There are certainly optimizations that will take place but this is a solid foundation to refine the system as it goes along. Results will be outlined below.

On another note, I need to begin compiling a poster for the CS Research Day on January 19th. Unfortunately, I will be away this weekend (on Saturday, the 10th) and the poster submission is due by 12:00 noon on Monday the 12th. That means that I will have to put a lot of work in on the 11th to finish the poster and have it ready for presentation. The goal of the poster is to show a progress update on the thesis; what are we doing, what has been done, what is remaining, and what is our end goal?

## Results of Query System

Two primary additions were made to the ppx system to bring vector embeddings as well as queries on the document. The vector embeddings are done using the `sentence-transformers` package; generating the embeddings with the default fast model of `all-MiniLM-L6-v2`. The embeddings are precomputed at this step and stored in the database as a `fragment_embeddings` object which maps to the `mistral_text_fragment` table through a `mistral_fragment_id` field.

To query the system we use the typr command `ppx query {document_name} "Query string"`. Several flags are available for this command:

- `--min-score=0.5 # To set the minimum score of a resultant query.`
- `--format=rich/json # output format, whether we want rich CLI output or json.`
- `--visualize # bool flag that will draw the resulting bounding boxes on the pages of the given document.`
- `--max_results=5 # maximum number of results to return. Ordered by score.`

The query system will embed the query and use cosine similarity (with `np.dot()`) to find all the `mistral_fragments` above the min-score threshold. It then uses _alignment between `ppx_text_fragments` and `mistral_text_fragments`_ to find the bounding box coordinates of the relevant text. For a desired higher degree of relevancy, we take the `page_element`, which is the larger data structure that makes up one or many `text_fragments`, that the text_fragment is contained in and return its bounding box.

We will now show some initial results using a MobileNetV2 paper as a demonstration:

### Query through the CLI

Using the following CLI `query` command we operate under the assumption that the document has undergone a standard parsing procedure:

1. Document added to data records.
2. Document parsed using PaddleX PP-OCRv5
   1. `PP-OCRv5_server_det` for text detection
   2. `PP-OCRv5_server_rec` for text recognition
3. Mistral API parses document for canonical markdown.
4. Alignment between PaddleX and Mistral.
5. Embeddings pre-computed for `mistral_text_fragments`.

We can then run a query command like so:

```console
> ppx query "What is ImageNet?"
╭───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── Query Results ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Query: What is ImageNet?                                                                                                                                                                                                                                                                                                                │
│ Results: 4 (min_score=0.5)                                                                                                                                                                                                                                                                                                              │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯
┏━━━━━┳━━━━━━━━┳━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ #   ┃ Score  ┃ Page  ┃ Element    ┃ BBox                     ┃ Text                                     ┃
┡━━━━━╇━━━━━━━━╇━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 1   │ 0.666  │ 7     │ text       │ (654, 858, 1124, 1125)   │ For the ImageNet dataset, our archite... │
│ 2   │ 0.615  │ 8     │ reference… │ (158, 723, 614, 820)     │ - [5] Alex Krizhevsky, Ilya Sutskever... │
│ 3   │ 0.615  │ 5     │ (aggregat… │ (192, 341, 932, 1405)    │ # 6.1. ImageNet Classification           │
│ 4   │ 0.564  │ 8     │ reference… │ (158, 192, 614, 364)     │ - [1] Olga Russakovsky, Jia Deng, Hao... │
└─────┴────────┴───────┴────────────┴──────────────────────────┴──────────────────────────────────────────┘
```

And, if we use the `--visualize` flag, we can see the bounding boxes drawn on the original pages of the document:

```console
> ppx query "What is ImageNet?" --visualize
╭─────────────────────────────────────────────────────── Query Results ─────────────────────────────────────╮
│ Query: What is ImageNet?                                                                                  │
│ Results: 4 (min_score=0.5)                                                                                │
╰───────────────────────────────────────────────────────────────────────────────────────────────────────────╯
┏━━━━━┳━━━━━━━━┳━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ #   ┃ Score  ┃ Page  ┃ Element    ┃ BBox                     ┃ Text                                     ┃
┡━━━━━╇━━━━━━━━╇━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ 1   │ 0.666  │ 7     │ text       │ (654, 858, 1124, 1125)   │ For the ImageNet dataset, our archite... │
│ 2   │ 0.615  │ 8     │ reference… │ (158, 723, 614, 820)     │ - [5] Alex Krizhevsky, Ilya Sutskever... │
│ 3   │ 0.615  │ 5     │ (aggregat… │ (192, 341, 932, 1405)    │ # 6.1. ImageNet Classification           │
│ 4   │ 0.564  │ 8     │ reference… │ (158, 192, 614, 364)     │ - [1] Olga Russakovsky, Jia Deng, Hao... │
└─────┴────────┴───────┴────────────┴──────────────────────────┴──────────────────────────────────────────┘
```

| Page 7                                    | Page 8                                    | Page 5                                    |
| ----------------------------------------- | ----------------------------------------- | ----------------------------------------- |
| ![Page 7](/blog-assets/thesis/page_7.jpg) | ![Page 8](/blog-assets/thesis/page_8.jpg) | ![Page 5](/blog-assets/thesis/page_5.jpg) |

Notice that page 5 is a bounding box that should indicate the header of a paragraph. The actual `page_element` record that was detected by PaddleX stored it as a `paragraph_title` for the element type. This is known issue in the system where an aggregation fallback is being used for certain bounding boxes.

## Next Steps

The primary next steps are to compile the progress of research and put it together in a poster. The important aspect of any technological research is that there is ample progress being made and the external pressure of sharing findings greatly helps with that.

In terms of the system itself there are fine-tunings and refinements required for both the alignment and querying systems. Some immediate tasks I've identified below:

1. Validate 86% estimate on accurate alignment between `mistral_text_fragments` and `ppx_text_fragments`.
2. Reduce false-positives from alignment step.
   1. The system returns 99.7% alignment, which is positively incorrect.
   2. Create _golden set_ of alignment mappings between ppx_text_fragments and mistral_text_fragments.
   3. Mask input for figures and footnotes if required.
3. Fix aggregate bug in querying function.
4. Put together a frontend and REST api that shows off the features of the system.

## Poster Presentation Layout

1. What is PPX?
   1. Goal of research.
   2. Technologies
2. PaddlePaddle OCR
3. Mistral
4. Alignment: Why is it important?
5. Querying with Embeddings
6. Planned Evaluations
7. Goal of Research

End with references
